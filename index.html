<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spectrum Fake</title>
<style>
:root {
  --bg:#008080;--gray:#c0c0c0;--dark:#808080;--light:#fff;--navy:#000080;
  --black:#000;--green:#0f0;--red:#f00;--yellow:#ff0;
  --font:'Times New Roman',Courier,serif;
}
*{box-sizing:border-box;user-select:none}
body{margin:0;background:var(--bg);height:100vh;font-family:var(--font);font-size:11px;overflow:hidden}
.app{display:grid;grid-template-areas:"h h""m s""d d";grid-template-rows:auto 1fr 24px;grid-template-columns:1fr 90px;height:100%;padding:1px;background:var(--gray);gap:1px}
.win-out{border:3px solid;border-color:var(--light) var(--dark) var(--dark) var(--light);box-shadow:1px 1px 0 var(--black) inset,-1px -1px 0 var(--black) inset}
.win-in{border:3px solid;border-color:var(--dark) var(--light) var(--light) var(--dark);background:var(--light);box-shadow:1px 1px 2px rgba(0,0,0,.5) inset}

#header{grid-area:h;display:flex;gap:4px;padding:3px;background:var(--navy);color:var(--light);align-items:center;margin-bottom:1px}
#answer-phrase{color:var(--yellow);font-weight:bold;font-size:13px;padding:2px 6px;background:rgba(0,0,0,.4);border:1px solid rgba(0,0,0,.5);min-height:18px}
#answer-phrase:empty{display:none}
#acct-name{color:var(--gray);font-weight:bold;min-width:200px;font-size:12px}
#acct-name.active{color:var(--red)}
#clock{background:var(--black);color:var(--green);padding:2px 6px;font-family:'Courier New',monospace;border:2px inset;font-weight:bold}
.tab{background:var(--gray);color:var(--black);padding:2px 6px;border:3px outset var(--light);font-size:10px;font-weight:bold;box-shadow:1px 1px 0 rgba(0,0,0,.3)}
#acct-id{margin-left:auto}

#main{grid-area:m;display:grid;grid-template-rows:1fr 2fr;gap:2px;padding-right:2px;overflow:hidden}
#main.dim section{pointer-events:none;opacity:.6;filter:brightness(.9)}
section{background:var(--light);overflow:auto;position:relative;min-height:0}

#bottom-area{display:grid;grid-template-columns:1fr 1fr;gap:2px;min-height:0}
#left-col,#right-col{display:flex;flex-direction:column;gap:2px;min-height:0;overflow:hidden}
#left-col>section,#right-col>section{flex:1;min-height:0}
#disclaimer,#disclaimer-oncall{flex:0 0 32px!important;min-height:32px;max-height:32px}

#script{font-family:'Courier New',monospace;padding:5px;white-space:pre-wrap;font-size:12px;font-weight:bold}
#script .placeholder{color:#888;font-style:italic}
.sc-good{color:green;font-weight:bold}
.sc-warn{color:red;font-weight:bold;background:#ffe0e0;padding:1px 3px}

#disclaimer,#disclaimer-oncall{background:#ffffc0;padding:4px 8px;display:flex;align-items:center;font-weight:bold;overflow:hidden;border:2px solid #e0e000}
#disclaimer-oncall{font-size:10px}

#form{padding:5px;background:var(--bg);overflow-y:auto}
.form-hint{color:var(--yellow);font-weight:bold;margin-bottom:4px;font-size:11px;background:rgba(0,0,0,.3);padding:3px 6px;border:1px solid rgba(0,0,0,.4)}
.step{display:none}.step.active{display:block}
.field{margin-bottom:3px}
.field .lbl{font-weight:bold;display:block;margin-bottom:1px;color:var(--light);font-size:11px}
.field input,.field select,.field textarea{width:100%;border:3px inset;font-family:var(--font);font-size:11px;padding:2px;background:var(--light);box-shadow:1px 1px 2px rgba(0,0,0,.4) inset}
.field.locked input,.field.locked select,.field.locked textarea,.field.locked .dd-disp{background:#ddd!important;color:#666;pointer-events:none}
.field.active input,.field.active select,.field.active textarea,.field.active .dd-disp{background:#ffffc0!important;outline:3px solid var(--red);outline-offset:-3px}
#form .submit-bar{margin-top:8px;background:var(--gray);border:3px outset;padding:6px;text-align:center;font-weight:bold;display:none;box-shadow:1px 1px 0 rgba(0,0,0,.3)}
#form .submit-bar.show{display:flex}

.dd-wrap{position:relative}
.dd-disp{border:3px inset;background:var(--light);padding:2px 4px;cursor:pointer;display:flex;justify-content:space-between;box-shadow:1px 1px 2px rgba(0,0,0,.4) inset}
.dd-list{position:absolute;top:100%;left:0;right:0;background:var(--light);border:3px solid var(--black);z-index:100;max-height:200px;overflow-y:auto;display:none;box-shadow:2px 2px 4px rgba(0,0,0,.5)}
.dd-list.open{display:block}
.dd-opt{padding:2px 4px;cursor:pointer;font-weight:bold}
.dd-opt:hover,.dd-opt.sel{background:var(--navy);color:var(--light)}

#oncall{padding:0;display:flex;flex-direction:column}
#oc-header{background:var(--gray);border-bottom:3px outset var(--light);padding:2px 4px;display:flex;justify-content:flex-end;gap:2px}
#oc-list{flex:1;overflow-y:auto}
.oc-row{display:grid;grid-template-columns:1fr 1fr;border-bottom:2px solid #888;padding:3px 5px;cursor:pointer;font-weight:bold}
.oc-row:hover{background:#e0e0e0}
.oc-row.sel{background:var(--navy);color:var(--light)}
.oc-sub{grid-column:1/-1;font-size:10px;color:var(--dark);font-weight:normal}
.oc-row.sel .oc-sub{color:#aaa}

#sidebar{grid-area:s;display:grid;grid-template-rows:repeat(22,1fr);gap:1px;background:var(--gray);padding:1px}
.btn{border:3px outset var(--light);background:linear-gradient(to bottom,#d4d4d4 0%,#c0c0c0 45%,#a8a8a8 55%,#b0b0b0 100%);font-size:9px;font-weight:bold;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:1px 1px 0 rgba(0,0,0,.3)}
.btn:active{border-style:inset;background:linear-gradient(to bottom,#a8a8a8 0%,#c0c0c0 100%)}
.btn.yel{background:linear-gradient(to bottom,#ffff00,#e0e000)}
.btn.pnk{background:linear-gradient(to bottom,#ffccff,#ee88ee)}
.btn.red{background:linear-gradient(to bottom,#ff6666,#dd4444)}
.btn.blk{background:#000;color:#0f0;font-family:'Courier New',monospace;border:3px inset}

#dbar{grid-area:d;background:var(--gray);border-top:3px outset var(--light);padding:2px 4px;display:flex;align-items:center}
#dbar.input{background:var(--yellow)}
#dbar-in{flex:1;background:var(--light);border:3px inset;font-family:'Courier New',monospace;padding:2px;display:none;box-shadow:1px 1px 2px rgba(0,0,0,.4) inset}
#dbar.input #dbar-in{display:block}
#dbar-status{font-size:10px;color:var(--dark);font-weight:bold}

#overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999;display:none;align-items:center;justify-content:center}
#overlay.show{display:flex}
.popup{background:var(--gray);border:3px outset var(--light);min-width:320px;max-width:400px;box-shadow:4px 4px 8px rgba(0,0,0,.6)}
.pop-h{background:var(--navy);color:var(--light);padding:3px 6px;font-weight:bold;display:flex;justify-content:space-between;font-size:12px}
.pop-x{cursor:pointer;padding:0 4px}
.pop-b{padding:6px;max-height:350px;overflow-y:auto}
.pop-search{margin-bottom:6px}
.pop-search input{width:100%;border:3px inset;padding:2px;font-size:11px;box-shadow:1px 1px 2px rgba(0,0,0,.4) inset}
.pop-item{padding:4px;border-bottom:2px dotted var(--dark);cursor:pointer;font-weight:bold}
.pop-item:hover,.pop-item.sel{background:var(--navy);color:var(--light)}
.pop-acts{display:flex;gap:4px;padding:6px;justify-content:center;border-top:3px groove var(--light)}
.pop-acts button{padding:4px 12px;border:3px outset var(--light);background:linear-gradient(to bottom,#d4d4d4,#c0c0c0);font-weight:bold;cursor:pointer;box-shadow:1px 1px 0 rgba(0,0,0,.3)}
.pop-acts button:active{border-style:inset;background:linear-gradient(to bottom,#a8a8a8,#c0c0c0)}
.pop-detail{padding:8px}
.pop-detail div{margin-bottom:4px;font-weight:bold}
.pop-detail .name{font-size:14px;font-weight:bold}
.pop-detail .note{background:#ffffc0;border:2px solid #cc0;padding:6px;margin-top:8px;font-style:italic;font-weight:normal}
.dial-num{font-size:28px;font-family:'Courier New',monospace;text-align:center;padding:20px;color:var(--green);background:var(--black);border:3px inset;font-weight:bold}
.msg-pre{font-family:'Courier New',monospace;font-size:10px;white-space:pre-wrap;background:#f8f8f8;padding:8px;border:3px inset;max-height:200px;overflow:auto;font-weight:bold;box-shadow:1px 1px 2px rgba(0,0,0,.4) inset}
.popup.dial-mode .pop-x{display:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENHANCEMENT: New Feature Styles
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#sidebar { position: relative; z-index: 1001 }

.field-section {
    background: var(--gray);
    padding: 6px 8px;
    margin: 4px 0;
    border: 3px outset;
    font-weight: bold;
    text-align: center;
    color: var(--black);
    box-shadow: 1px 1px 0 rgba(0,0,0,.3);
}

.field-label {
    padding: 2px 4px;
    margin-bottom: 4px;
    font-size: 10px;
    font-weight: bold;
}
.field-label.yellow {
    color: #ff0;
    background: rgba(0,0,0,.3);
    border: 1px solid rgba(0,0,0,.4);
    padding: 3px 6px;
}
.field-label.gray {
    color: var(--light);
    font-weight: bold;
}

.hl-blue {
    background: var(--navy);
    color: var(--light);
    padding: 1px 4px;
    font-weight: bold;
}
.hl-red {
    background: var(--red);
    color: var(--light);
    padding: 1px 4px;
    font-weight: bold;
}

.form-preview {
    background: #f8f8f8;
    border: 3px inset;
    padding: 6px;
    margin-bottom: 8px;
    font-family: 'Courier New', monospace;
    font-size: 10px;
    white-space: pre-wrap;
    font-weight: bold;
    box-shadow: 1px 1px 2px rgba(0,0,0,.4) inset;
}

::-webkit-scrollbar{width:18px;height:18px}
::-webkit-scrollbar-track{background:var(--gray);border:2px solid;border-color:var(--dark) var(--light) var(--light) var(--dark)}
::-webkit-scrollbar-thumb{background:linear-gradient(to bottom,#d4d4d4,#c0c0c0);border:2px outset var(--light);box-shadow:1px 1px 0 rgba(0,0,0,.2)}
::-webkit-scrollbar-thumb:active{border-style:inset;background:linear-gradient(to bottom,#a8a8a8,#c0c0c0)}
::-webkit-scrollbar-button{background:linear-gradient(to bottom,#d4d4d4,#c0c0c0);border:2px outset var(--light);height:18px;display:block}
::-webkit-scrollbar-button:active{border-style:inset}
::-webkit-scrollbar-button:vertical:decrement{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M8 4 L4 10 L12 10 Z" fill="%23000"/></svg>');background-repeat:no-repeat;background-position:center}
::-webkit-scrollbar-button:vertical:increment{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M8 12 L4 6 L12 6 Z" fill="%23000"/></svg>');background-repeat:no-repeat;background-position:center}
</style>
</head>
<body>

<div class="app win-out">
  <header id="header" class="win-out">
    <div id="answer-phrase"></div>
    <div id="acct-name">SELECT ACCOUNT</div>
    <div id="clock">--:--:--</div>
    <div class="tab">DEL: 0</div>
    <div class="tab">PROG: 0</div>
    <div class="tab" id="acct-id">ID: ----</div>
  </header>
  <main id="main" class="dim">
    <section id="script" class="win-in"></section>
    <div id="bottom-area">
      <div id="left-col">
        <section id="disclaimer-oncall" class="win-in"></section>
        <section id="oncall" class="win-in"></section>
      </div>
      <div id="right-col">
        <section id="disclaimer" class="win-in"></section>
        <section id="form" class="win-in"></section>
      </div>
    </div>
  </main>
  <aside id="sidebar" class="win-out"></aside>
  <footer id="dbar"><input id="dbar-in" placeholder="ACCOUNT ID OR NAME..."><span id="dbar-status">READY</span></footer>
</div>

<div id="overlay"><div class="popup"><div class="pop-h"><span id="pop-title">POPUP</span><span class="pop-x" onclick="S.popup=null">âœ•</span></div><div class="pop-b" id="pop-body"></div><div class="pop-acts" id="pop-acts"></div></div></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE: Reactive State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Bus = new EventTarget();
const S = new Proxy({ account: null, form: { step: 0, idx: 0, vals: {} }, popup: null, mode: 'IDLE', editId: null, viewMsg: null }, {
  set(t, k, v) { t[k] = v; Bus.dispatchEvent(new CustomEvent(k, { detail: v })); return true; }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA: Accounts & Storage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB = {
  accounts: {
    '2000': {
      id: '2000', name: 'Training Account 6-7',
      answerPhrase: 'Thank you for calling Training Services, how may I help you?',
      script: [
        { text: 'â•â•â• TRAINING ACCOUNT - APPOINTMENT SCHEDULING â•â•â•', style: 'normal' },
        { text: '\nâœ“ Verify caller identity using <span class="hl-blue">2-factor authentication</span>', style: 'good' },
        { text: 'âœ“ Confirm appointment location from approved list', style: 'good' },
        { text: 'âœ“ Document all caller requests in notes field', style: 'good' },
        { text: '\nâš  DO NOT provide <span class="hl-red">pricing information</span> over phone', style: 'warn' },
        { text: 'âš  NEVER confirm <span class="hl-red">account numbers</span> verbally', style: 'warn' },
        { text: '\nSteps:\n  1. Greet caller professionally\n  2. Verify identity\n  3. Process request\n  4. Confirm details\n  5. Thank caller', style: 'normal' }
      ],
      disclaimer: 'IFS DISCLAIMER: Training simulation only. Do not enter real customer PII. All data is logged for QA purposes.',
      form: {
        hint: 'Tab through fields â€¢ Shift+Enter to submit',
        steps: [
          [
            { type: 'section', text: 'â•â•â• CALLER VERIFICATION â•â•â•' },
            { type: 'label', text: 'Verify identity before proceeding', style: 'yellow' },
            { id: 'loc', type: 'dropdown', label: 'Service Location', opts: ['New York - Manhattan', 'New York - Brooklyn', 'Chicago - Downtown', 'Chicago - Suburbs', 'Los Angeles - Central', 'Los Angeles - Valley'] },
            { id: 'name', type: 'text', label: 'Caller Full Name', req: true }
          ],
          [
            { type: 'section', text: 'â•â•â• CONTACT INFORMATION â•â•â•' },
            { id: 'phone', type: 'phone', label: 'Callback Number', req: true },
            { id: 'email', type: 'email', label: 'Email Address' },
            { type: 'label', text: 'Confirm spelling of email address', style: 'gray' },
            { id: 'type', type: 'dropdown', label: 'Appointment Type', opts: ['New Installation', 'Service Repair', 'Equipment Upgrade', 'General Inquiry', 'Billing Question'] }
          ]
        ]
      },
      oncalls: [
        { id: 'oc1', label: 'Day Manager', name: 'John Smith', times: '9:00 AM - 5:00 PM EST', dial: '555-0101', note: 'Contact for escalations and schedule changes. Prefers email first.' },
        { id: 'oc2', label: 'Night Supervisor', name: 'Jane Doe', times: '5:00 PM - 12:00 AM EST', dial: '555-0102', note: 'Emergency contact only. Do not disturb for routine matters.' },
        { id: 'oc3', label: 'Technical Lead', name: 'Bob Robertson', times: '24/7 On-Call', dial: '555-0103', note: 'System outages and technical emergencies only.' },
        { id: 'oc4', label: 'Weekend Support', name: 'Alice Wang', times: 'Sat-Sun 8AM-8PM', dial: '555-0104', note: '' }
      ],
      info: [
        'PAGE 1: OVERVIEW\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWelcome to the Training Account.\n\nThis account is used for new agent\ntraining and certification testing.\n\nUse PageUp/PageDown to navigate\nbetween information pages.',
        'PAGE 2: POLICIES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Always verify caller identity\n2. Document all interactions\n3. Escalate when uncertain\n4. Maintain professional tone\n5. Follow script guidelines\n6. Complete all required fields',
        'PAGE 3: STATUS CODES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ”´ RED: Urgent/Emergency\nğŸ”µ BLUE: Standard Request  \nğŸŸ¡ YELLOW: On Hold/Pending\nğŸŸ¢ GREEN: Completed/Resolved\nâšª WHITE: Cancelled/Void',
        'PAGE 4: SHORTCUTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n+ : Quick account search\nF2 : Message history\nF12 : Edit current message\nShift+F4 : Duplicate message\nTab : Next field\nShift+Enter : Submit form\nEsc : Close/Cancel'
      ]
    },
    '0547': {
      id: '0547', name: 'Canada Dry Bottling Company',
      answerPhrase: 'Thank you for calling Canada Dry Bottling Company, how may I help you?',
      script: [
        { text: 'Call handling instructions', style: 'good' },
        { text: 'Take message. Staff will return the call once available.', style: 'normal' }
      ],
      disclaimer: 'Call handling instructions: Take message. Staff will return the call once available.',
      form: {
        hint: 'Enter message details',
        steps: [[
          { id: 'for_field', type: 'text', label: 'For' },
          { id: 'name', type: 'text', label: 'Name' },
          { id: 'phone', type: 'phone', label: 'Phone' },
          { id: 'co_store', type: 'text', label: 'Co/Store' },
          { id: 'acct_order', type: 'text', label: 'Acct/Order' },
          { id: 'address', type: 'textarea', label: 'Address' },
          { id: 'message', type: 'textarea', label: 'Message' }
        ]]
      },
      oncalls: [],
      info: ['INSTRUCTIONS:\n\nTake message. Staff will return the call once available.']
    }
  },
  msgs(id) { return JSON.parse(localStorage.getItem(`msgs_${id}`) || '[]'); },
  save(id, data, editId = null) {
    const k = `msgs_${id}`, arr = this.msgs(id), now = new Date().toISOString();
    if (editId) { const i = arr.findIndex(m => m.id === editId); if (i > -1) arr[i] = { ...arr[i], data, updated: now }; }
    else arr.unshift({ id: crypto.randomUUID(), data, created: now, label: S.account?.oncalls?.[0]?.label || 'Form' });
    localStorage.setItem(k, JSON.stringify(arr));
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPONENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Component {
  constructor(sel) { this.el = document.getElementById(sel); }
  configure(schema) { this.schema = schema; this.render(); return this; }
  render() { this.el.innerHTML = ''; }
  key(e) {}
}

class Script extends Component {
  render() {
    this.el.innerHTML = !this.schema ? '<div class="placeholder">Select an account to view script...</div>' :
      this.schema.map(b => `<div class="${b.style === 'good' ? 'sc-good' : b.style === 'warn' ? 'sc-warn' : ''}">${b.text}</div>`).join('');
  }
}

class Oncall extends Component {
  constructor(sel) { super(sel); this.sel = -1; }
  configure(s) { this.sel = -1; return super.configure(s || []); }
  render() {
    this.el.innerHTML = `<div id="oc-header"><div class="btn" style="width:20px;height:20px" onclick="C.oncall.scroll(-1)">â–²</div><div class="btn" style="width:20px;height:20px" onclick="C.oncall.scroll(1)">â–¼</div></div><div id="oc-list"></div>`;
    const list = this.el.querySelector('#oc-list');
    list.innerHTML = this.schema.map((o, i) =>
      `<div class="oc-row${i === this.sel ? ' sel' : ''}" data-i="${i}"><b>${o.label}</b><span style="text-align:right">${o.name}</span><div class="oc-sub">${o.times}</div></div>`
    ).join('');
    list.querySelectorAll('.oc-row').forEach(r => r.onclick = () => { this.sel = +r.dataset.i; this.render(); this.open(); });
  }
  scroll(dir) {
    const list = this.el.querySelector('#oc-list');
    list.scrollBy({ top: dir * 40, behavior: 'smooth' });
  }
  key(e) {
    // Keyboard controls removed to avoid taking focus from the form
  }
  open() { S.popup = { type: 'oncall', data: this.schema[this.sel] }; }
}

class Form extends Component {
  getInteractiveSteps() {
    if (!this.schema?.steps) return [];
    return this.schema.steps.map(s =>
      s.filter(f => f.type !== 'section' && f.type !== 'label')
    );
  }
  configure(s) {
    this.schema = s; 
    this.fields = []; 
    this.el.innerHTML = '';
    
    // Guard: If no schema, stop here
    if (!s?.steps?.length) return this;
    
    // Render Steps
    if (s.hint) this.el.insertAdjacentHTML('beforeend', `<div class="form-hint">${s.hint}</div>`);
    s.steps.forEach((step, si) => {
      const div = document.createElement('div');
      div.className = 'step';
      step.forEach(f => {
        // â•â•â• NEW: Handle procedural display elements â•â•â•
        if (f.type === 'section') {
          const sec = document.createElement('div');
          sec.className = 'field-section';
          sec.textContent = f.text;
          div.appendChild(sec);
          return;
        }
        if (f.type === 'label') {
          const lbl = document.createElement('div');
          lbl.className = 'field-label ' + (f.style || '');
          lbl.textContent = f.text;
          div.appendChild(lbl);
          return;
        }
        // â•â•â• END NEW â•â•â•

        const w = document.createElement('div');
        w.className = 'field';
        w.innerHTML = `<label class="lbl">${f.label}${f.req ? ' *' : ''}</label>` + (
          f.type === 'dropdown' ? `<div class="dd-wrap"><div class="dd-disp" tabindex="0"><span>${f.opts?.[0] || ''}</span><span>â–¼</span></div><div class="dd-list">${(f.opts || []).map((o, i) => `<div class="dd-opt${i === 0 ? ' sel' : ''}">${o}</div>`).join('')}</div></div>` :
          f.type === 'textarea' ? '<textarea rows="2"></textarea>' : `<input type="${f.type === 'phone' ? 'tel' : f.type === 'email' ? 'email' : 'text'}">`
        );
        div.appendChild(w);
        this.fields.push({ el: w, step: si, schema: f, val: f.opts?.[0] || '' });
      });
      this.el.appendChild(div);
    });
    
    this.el.insertAdjacentHTML('beforeend', '<div class="submit-bar btn" onclick="C.form.submit()">SUBMIT (SHIFT+ENTER)</div>');
    return this.sync();
  }

  sync() {
    // If fields are empty (Success State), do nothing
    if (!this.fields.length) return this;

    const { step, idx } = S.form;
    this.el.querySelectorAll('.step').forEach((s, i) => s.classList.toggle('active', i === step));

    const interactiveByStep = this.getInteractiveSteps();
    let gi = 0;
    interactiveByStep.forEach((stepFields, si) => stepFields.forEach((_, fi) => {
      const f = this.fields[gi], isAct = si === step && fi === idx, isPast = si < step || (si === step && fi < idx);
      f.el.classList.toggle('active', isAct);
      f.el.classList.toggle('locked', isPast);

      const inp = f.el.querySelector('input,textarea');
      if (inp) {
        f.val = inp.value;
        if (isAct) { inp.focus(); inp.select(); }
      } else {
        f.el.querySelector('.dd-disp span').textContent = f.val || 'Select...';
        if (isAct) f.el.querySelector('.dd-disp').focus();
      }
      gi++;
    }));

    const last = step === (this.schema?.steps?.length || 1) - 1;
    this.el.querySelector('.submit-bar')?.classList.toggle('show', last);
    return this;
  }

  curField() {
    if (!this.fields.length) return null;
    const steps = this.getInteractiveSteps();
    let i = 0;
    for (let s = 0; s < S.form.step; s++) i += steps[s].length;
    return this.fields[i + S.form.idx];
  }

  nav(dir) {
    if (!this.fields.length) return; // Block nav in success state
    const { step, idx } = S.form;
    const steps = this.getInteractiveSteps();
    const isLast = step === steps.length - 1 && idx === steps[step].length - 1;

    if (dir > 0) {
      if (idx < steps[step].length - 1) S.form = { ...S.form, idx: idx + 1 };
      else if (step < steps.length - 1) S.form = { ...S.form, step: step + 1, idx: 0 };
      else if (isLast) return this.submit();
    } else {
      if (idx > 0) S.form = { ...S.form, idx: idx - 1 };
      else if (step > 0) S.form = { ...S.form, step: step - 1, idx: steps[step - 1].length - 1 };
    }
    this.sync();
  }

  key(e) {
    if (!this.schema) return;

    // PATCH: Handle Success State (Schema exists, but fields are wiped)
    if (this.fields.length === 0) {
      if (e.key === 'Enter') { e.preventDefault(); this.reset(); }
      return;
    }

    const f = this.curField();
    if (!f) return;

    // Dropdown Logic
    if (f.schema.type === 'dropdown') {
      const list = f.el.querySelector('.dd-list'), open = list.classList.contains('open'), opts = f.schema.opts, cur = opts.indexOf(f.val);
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (!open) list.classList.add('open');
        else if (cur < opts.length - 1) { f.val = opts[cur + 1]; list.querySelectorAll('.dd-opt').forEach((o, i) => o.classList.toggle('sel', i === cur + 1)); }
        return;
      }
      if (e.key === 'ArrowUp' && open) { e.preventDefault(); if (cur > 0) { f.val = opts[cur - 1]; list.querySelectorAll('.dd-opt').forEach((o, i) => o.classList.toggle('sel', i === cur - 1)); } return; }
      if (e.key === 'Enter' && open) { e.preventDefault(); list.classList.remove('open'); this.sync(); return; }
      if (e.key === 'Escape' && open) { e.preventDefault(); list.classList.remove('open'); return; }
    }
    
    // Nav Logic
    if (e.key === 'Tab') { e.preventDefault(); this.nav(e.shiftKey ? -1 : 1); }
    if (e.key === 'Enter') { e.preventDefault(); if (e.shiftKey) this.submit(); else this.nav(1); }
  }

  submit() {
    if (!S.account) return;

    // 1. Capture ONLY user-entered data (for display)
    const userData = {};
    this.fields.forEach(f => {
      const inp = f.el.querySelector('input,textarea');
      if (inp) f.val = inp.value;
      userData[f.schema.id] = f.val;
    });

    // 1.5. Create save data with auto-generated metadata
    // These are stored but NOT displayed to the user
    const saveData = { ...userData };
    const now = new Date();
    saveData._date = now.toLocaleDateString('en-US');
    const hour = now.getHours();
    const timeOpts = ['Morning (8AM-12PM)', 'Afternoon (12PM-5PM)', 'Evening (5PM-8PM)'];
    saveData._time = timeOpts[hour < 12 ? 0 : hour < 17 ? 1 : 2];
    saveData._notes = 'System-generated assignment';

    // 2. Persist (save includes metadata)
    DB.save(S.account.id, saveData, S.editId);

    // 3. Render Success State
    const preview = Object.entries(userData)
        .map(([key, value]) => `${key}: ${value}`)
        .join('\n');

    // 3a. CRITICAL: Hide ALL steps to prevent locked fields from showing
    this.el.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
    });

    // 3b. Lock all fields (defensive, in case any are still accessible)
    this.el.querySelectorAll('.field').forEach(field => {
        field.classList.add('locked');
        field.classList.remove('active');
    });

    // 3c. Hide the form hint (no longer applicable)
    const hint = this.el.querySelector('.form-hint');
    if (hint) hint.style.display = 'none';

    // 3d. Show preview at top
    const previewDiv = document.createElement('div');
    previewDiv.className = 'form-preview';
    previewDiv.textContent = preview;
    this.el.insertBefore(previewDiv, this.el.firstChild);

    // 3e. Remove submit bar
    const submitBar = this.el.querySelector('.submit-bar');
    if (submitBar) {
        submitBar.remove();
    }

    // 4. Lock navigation by clearing fields array
    this.fields = [];
    document.getElementById('dbar-status').textContent = S.editId ? 'âœ“ UPDATED' : 'âœ“ SENT';
  }

  reset() {
    S.editId = null; 
    S.form = { step: 0, idx: 0, vals: {} };
    document.getElementById('dbar-status').textContent = 'READY';
    this.configure(this.schema);
    
    // Ensure hint is visible (defensive - configure() should handle this)
    const hint = this.el.querySelector('.form-hint');
    if (hint) hint.style.display = '';
  }

  fill(data) {
    this.fields.forEach(f => {
      if (data[f.schema.id] !== undefined) {
        f.val = data[f.schema.id];
        const inp = f.el.querySelector('input,textarea');
        if (inp) inp.value = f.val;
      }
    });
    const steps = this.getInteractiveSteps();
    S.form = { step: steps.length - 1, idx: steps[steps.length - 1].length - 1, vals: {} };
    this.sync();
  }
}

class Popup extends Component {
  constructor(sel) { super(sel); this.sel = 0; this.list = []; this.filter = ''; }
  render() {
    const o = document.getElementById('overlay'), t = document.getElementById('pop-title'), b = document.getElementById('pop-body'), a = document.getElementById('pop-acts');
    const popup = document.querySelector('.popup');
    popup.classList.remove('dial-mode');
    o.classList.toggle('show', !!S.popup);
    if (!S.popup) return;
    const { type, data } = S.popup;
    this.sel = 0; this.list = [];
    if (type === 'accounts') {
      t.textContent = 'SELECT ACCOUNT';
      this.list = Object.values(DB.accounts).filter(ac => !this.filter || ac.id.includes(this.filter) || ac.name.toLowerCase().includes(this.filter.toLowerCase()));
      b.innerHTML = `<div class="pop-search"><input id="acct-search" placeholder="Search ID or name..." value="${this.filter}"></div>` +
        (this.list.length ? this.list.map((ac, i) => `<div class="pop-item${i === this.sel ? ' sel' : ''}" data-i="${i}">${ac.id} â€” ${ac.name}</div>`).join('') : '<div style="padding:8px;color:#888">No accounts found</div>');
      a.innerHTML = '';
      setTimeout(() => {
        const s = document.getElementById('acct-search');
        s?.focus();
        s?.addEventListener('input', e => { this.filter = e.target.value; this.render(); });
      }, 0);
    } else if (type === 'messages') {
      t.textContent = `HISTORY â€” ${S.account.name}`;
      this.list = data;
      b.innerHTML = this.list.length ? this.list.map((m, i) => `<div class="pop-item${i === this.sel ? ' sel' : ''}" data-i="${i}"><b>${m.label || 'Message'}</b><br><small>${new Date(m.created).toLocaleString()}</small></div>`).join('') : '<div style="padding:8px;color:#888">No messages yet.</div>';
      a.innerHTML = '';
    } else if (type === 'oncall') {
      t.textContent = 'CONTACT DETAIL';
      b.innerHTML = `<div class="pop-detail"><div class="name">${data.name}</div><div>${data.label}</div><div>${data.times}</div>${data.note ? `<div class="note">${data.note}</div>` : ''}</div>`;
      a.innerHTML = '<button onclick="C.popup.pmd()">PMD</button><button onclick="C.popup.dial()">DIAL</button>';
    } else if (type === 'dial') {
      t.textContent = 'DIALING...';
      b.innerHTML = `<div class="dial-num">${data}</div>`;
      a.innerHTML = '';
      popup.classList.add('dial-mode');
    } else if (type === 'msg_view') {
      t.textContent = 'MESSAGE DETAIL';
      S.viewMsg = data;
      b.innerHTML = `<div><small>${new Date(data.created).toLocaleString()}${data.updated ? ' (edited)' : ''}</small></div><div class="msg-pre">${Object.entries(data.data).map(([k, v]) => `${k}: ${v}`).join('\n')}</div>`;
      a.innerHTML = '';
    }
    b.querySelectorAll('.pop-item').forEach(el => el.onclick = () => this.pick(+el.dataset.i));
  }
  pick(i) {
    const { type } = S.popup;
    if (type === 'accounts') { const ac = this.list[i]; if (ac) { this.filter = ''; Actions.load(ac.id); } }
    else if (type === 'messages' && this.list[i]) S.popup = { type: 'msg_view', data: this.list[i] };
  }
  key(e) {
    if (!S.popup) return;
    if (e.key === 'Escape') { S.popup = null; return; }
    if (this.list.length) {
      if (e.key === 'ArrowDown') { e.preventDefault(); this.sel = Math.min(this.sel + 1, this.list.length - 1); this.render(); }
      if (e.key === 'ArrowUp') { e.preventDefault(); this.sel = Math.max(this.sel - 1, 0); this.render(); }
      if (e.key === 'Enter') { e.preventDefault(); this.pick(this.sel); }
    }
    if (S.popup?.type === 'msg_view') {
      // Arrow navigation through message history
      const msgs = DB.msgs(S.account.id);
      const currentIndex = msgs.findIndex(m => m.id === S.viewMsg.id);
      
      if (e.key === 'ArrowUp' && currentIndex > 0) {
        e.preventDefault();
        S.popup = { type: 'msg_view', data: msgs[currentIndex - 1] };
        return;
      }
      if (e.key === 'ArrowDown' && currentIndex < msgs.length - 1) {
        e.preventDefault();
        S.popup = { type: 'msg_view', data: msgs[currentIndex + 1] };
        return;
      }
      
      if (e.key === 'F12') { e.preventDefault(); this.editMsg(); }
      if (e.key === 'F4' && e.shiftKey) { e.preventDefault(); this.dupeMsg(); }
    }
  }
  pmd() { S.popup = null; document.getElementById('dbar-status').textContent = 'âœ“ PMD SENT'; setTimeout(() => document.getElementById('dbar-status').textContent = 'READY', 2000); }
  dial() { S.popup = { type: 'dial', data: S.popup.data.dial }; }
  editMsg() { S.editId = S.viewMsg.id; C.form.fill(S.viewMsg.data); S.popup = null; }
  dupeMsg() { C.form.fill(S.viewMsg.data); S.editId = null; S.popup = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS & WIRING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Actions = {
  load(id) {
    const ac = DB.accounts[id];
    if (!ac) { document.getElementById('dbar-status').textContent = 'âœ— NOT FOUND'; return; }
    S.account = ac; S.popup = null; S.form = { step: 0, idx: 0, vals: {} }; S.editId = null;
  },
  clear() {
    S.popup = null;
    if (S.account) {
      S.account = null; S.form = { step: 0, idx: 0, vals: {} };
      document.getElementById('answer-phrase').textContent = '';
      document.getElementById('acct-name').textContent = 'SELECT ACCOUNT';
      document.getElementById('acct-name').classList.remove('active');
      document.getElementById('acct-id').textContent = 'ID: ----';
      document.getElementById('disclaimer').textContent = '';
      document.getElementById('disclaimer-oncall').textContent = '';
      document.getElementById('main').classList.add('dim');
      C.script.configure(null); C.form.configure(null); C.oncall.configure(null);
    }
  }
};

const C = {
  script: new Script('script'),
  form: new Form('form'),
  oncall: new Oncall('oncall'),
  popup: new Popup('overlay')
};

// State subscriptions
Bus.addEventListener('account', e => {
  const ac = e.detail;
  if (!ac) return;
  document.getElementById('answer-phrase').textContent = ac.answerPhrase || '';
  document.getElementById('acct-name').textContent = ac.name;
  document.getElementById('acct-name').classList.add('active');
  document.getElementById('acct-id').textContent = `ID: ${ac.id}`;
  document.getElementById('disclaimer').textContent = ac.disclaimer || '';
  document.getElementById('disclaimer-oncall').textContent = ac.disclaimer || '';
  document.getElementById('main').classList.remove('dim');
  C.script.configure(ac.script);
  C.form.configure(ac.form);
  C.oncall.configure(ac.oncalls);
});
Bus.addEventListener('popup', () => C.popup.render());
Bus.addEventListener('mode', e => {
  const d = document.getElementById('dbar'), inp = document.getElementById('dbar-in');
  d.classList.toggle('input', e.detail === 'INPUT');
  document.getElementById('main').classList.toggle('dim', e.detail === 'INPUT' || !S.account);
  if (e.detail === 'INPUT') { inp.value = ''; inp.focus(); }
});

// Sidebar
const sidebar = document.getElementById('sidebar');
['SYS', 'QUEUE', 'ACCTS', 'BRWSR', 'DIAL', 'HOLD', 'XFER', 'CONF', 'PARK', 'PATCH', 'MUTE', 'REL', 'LOG', 'SUPV', 'HELP', 'MAIL', 'CHAT', 'CALC', 'NOTE', 'CLEAR', 'F2', 'PAGE'].forEach(b => {
  const btn = document.createElement('div');
  btn.className = 'btn' + ({ HOLD: ' yel', CONF: ' yel', PARK: ' pnk', PATCH: ' pnk', CLEAR: ' red', PAGE: ' blk' }[b] || '');
  btn.textContent = b;
  btn.onclick = () => {
    if (b === 'ACCTS') S.popup = { type: 'accounts' };
    else if (b === 'HOLD' && S.popup?.type === 'dial') S.popup = null;
    else if (b === 'CLEAR') Actions.clear();
    else if (b === 'F2' && S.account) S.popup = { type: 'messages', data: DB.msgs(S.account.id) };
  };
  sidebar.appendChild(btn);
});

// Clock
setInterval(() => {
  const d = new Date();
  document.getElementById('clock').textContent = d.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'America/New_York' }) + ' ' +
    d.toLocaleTimeString('en-US', { hour12: false, timeZone: 'America/New_York' });
}, 1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD CONTROLLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  // Display mode toggle
  if ((e.key === '+' || (e.key === '=' && e.shiftKey)) && S.mode !== 'INPUT') { e.preventDefault(); S.mode = 'INPUT'; return; }
  // Input mode handling
  if (S.mode === 'INPUT') {
    if (e.key === 'Escape' || e.key === '`') { S.mode = 'IDLE'; return; }
    if (e.key === 'Enter') { Actions.load(document.getElementById('dbar-in').value.trim()); S.mode = 'IDLE'; return; }
    return;
  }
  // Global hotkeys
  if (e.key === 'F2') { e.preventDefault(); if (S.account) S.popup = { type: 'messages', data: DB.msgs(S.account.id) }; return; }
  if (e.key === 'Escape') { if (S.popup) S.popup = null; return; }
  // Popup takes priority
  if (S.popup) { C.popup.key(e); return; }
  // Account-level delegation
  if (S.account) {
    // Form gets: Tab, Enter, and arrow keys when on dropdown OR dropdown is open
    if (e.key === 'Tab') { C.form.key(e); return; }
    if (e.key === 'Enter') { C.form.key(e); return; }
    
    const curField = C.form.curField?.();
    const isOnDropdown = curField?.schema?.type === 'dropdown';
    const isDropdownOpen = document.querySelector('.dd-list.open');
    
    if ((isOnDropdown || isDropdownOpen) && ['ArrowUp', 'ArrowDown', 'Escape'].includes(e.key)) {
      C.form.key(e);
      return;
    }

    // Oncall keyboard controls removed to prioritize Form functionality
  }
});
</script>
</body>
</html>
