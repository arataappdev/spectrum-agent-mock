<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spectrum Fake</title>
<style>
  :root {
    --bg: #008080; --gray: #c0c0c0; --dark: #808080; --light: #ffffff;
    --navy: #000080; --black: #000000; --green: #00ff00; --red: #ff0000;
    --font: 'MS Sans Serif', Tahoma, sans-serif;
  }
  * { box-sizing: border-box; user-select: none; }
  body { margin: 0; background: var(--bg); height: 100vh; font-family: var(--font); font-size: 11px; overflow: hidden; }
  
  /* Layout */
  .app { display: grid; grid-template-areas: "h h" "m s" "d d"; grid-template-rows: auto 1fr auto; grid-template-columns: 1fr 90px; height: 100%; padding: 2px; background: var(--gray); }
  .win-out { border: 2px solid; border-color: var(--light) var(--dark) var(--dark) var(--light); }
  .win-in { border: 2px solid; border-color: var(--dark) var(--light) var(--light) var(--dark); background: var(--light); }
  
  /* Header */
  #header { grid-area: h; display: flex; gap: 8px; padding: 4px; background: var(--navy); color: var(--light); align-items: center; margin-bottom: 2px; }
  #acct-name { color: var(--red); font-weight: bold; min-width: 250px; }
  #clock { background: var(--black); color: var(--green); padding: 2px 6px; font-family: monospace; border: 1px inset; }
  .tab { background: var(--gray); color: var(--black); padding: 2px 8px; border: 2px outset var(--light); }
  
  /* Main Area */
  #main { grid-area: m; display: grid; grid-template-rows: 2fr auto 3fr 2fr 2fr; gap: 4px; padding-right: 4px; overflow: hidden; }
  section { background: var(--light); overflow: auto; position: relative; }
  section.dim { pointer-events: none; opacity: 0.7; background: #ddd; }

  /* Script */
  #script { font-family: monospace; padding: 5px; white-space: pre-wrap; }
  .sc-good { color: green; font-weight: bold; }
  .sc-warn { color: red; font-weight: bold; }
  
  /* Disclaimer */
  #disclaimer { background: #ffffc0; padding: 4px; height: 40px; display: flex; align-items: center; font-weight: bold; }

  /* Form */
  #form { padding: 8px; background: var(--gray); }
  .form-hint { color: var(--navy); font-weight: bold; margin-bottom: 5px; }
  .step { display: none; }
  .step.active { display: block; }
  .field { margin-bottom: 4px; }
  .label { font-weight: bold; display: block; }
  input, select, textarea { width: 100%; border: 2px inset; font-family: var(--font); font-size: 11px; padding: 2px; background: var(--light); }
  .field.locked input, .field.locked select, .field.locked textarea { background: var(--gray); color: #555; pointer-events: none; }
  .field.active input, .field.active select, .field.active textarea { background: #ffffc0; }
  .submit-bar { margin-top: 10px; background: var(--gray); border: 2px inset; padding: 5px; text-align: center; font-weight: bold; color: var(--dark); display: none; }
  
  /* Dropdown Custom */
  .dd-wrap { position: relative; }
  .dd-disp { border: 2px inset; background: var(--light); padding: 2px; cursor: pointer; display: flex; justify-content: space-between; }
  .dd-list { position: absolute; top: 100%; left: 0; right: 0; background: var(--light); border: 2px solid var(--black); z-index: 100; max-height: 100px; overflow-y: auto; display: none; }
  .dd-opt { padding: 2px; cursor: pointer; }
  .dd-opt:hover, .dd-opt.sel { background: var(--navy); color: var(--light); }

  /* Oncall */
  .oc-row { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid #eee; padding: 2px; cursor: pointer; }
  .oc-row.sel { background: var(--navy); color: var(--light); }
  .oc-sub { grid-column: 1 / -1; font-size: 0.85em; color: var(--dark); padding-left: 4px; }
  .oc-row.sel .oc-sub { color: #ccc; }

  /* Info */
  #info { padding: 4px; display: flex; flex-direction: column; }
  #info-content { flex: 1; white-space: pre-wrap; overflow: hidden; }
  #info-pg { text-align: right; color: var(--dark); font-size: 0.8em; margin-top: 2px; }

  /* Sidebar */
  #sidebar { grid-area: s; display: grid; grid-template-rows: repeat(22, 1fr); gap: 2px; background: var(--gray); }
  .btn { border: 2px outset var(--light); background: var(--gray); font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }
  .btn:active { border-style: inset; }
  .btn.yel { background: #ffff00; } .btn.pnk { background: #ffccff; } .btn.blk { background: #000; color: #0f0; font-family: monospace; }

  /* Bottom Bar */
  #dbar { grid-area: d; background: var(--gray); border-top: 2px outset var(--light); padding: 2px; display: flex; align-items: center; }
  #dbar.input-mode { background: #ffff00; }
  #dbar-in { width: 100%; background: var(--light); border: 2px inset; font-family: monospace; display: none; }
  #dbar.input-mode #dbar-in { display: block; }

  /* Popups */
  #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; align-items: center; justify-content: center; }
  .popup { background: var(--gray); border: 2px outset var(--light); width: 350px; display: flex; flex-direction: column; box-shadow: 4px 4px 0 rgba(0,0,0,0.5); }
  .pop-h { background: var(--navy); color: var(--light); padding: 4px; font-weight: bold; display: flex; justify-content: space-between; }
  .pop-b { padding: 8px; max-height: 400px; overflow-y: auto; }
  .pop-item { padding: 4px; border-bottom: 1px dotted var(--dark); cursor: pointer; }
  .pop-item:hover, .pop-item.sel { background: var(--navy); color: var(--light); }
  .pop-act { display: flex; gap: 5px; padding: 4px; justify-content: center; border-top: 2px groove var(--light); }
</style>
</head>
<body>

<div class="app win-out">
  <header id="header" class="win-out">
    <div id="acct-name">SELECT ACCOUNT</div>
    <div id="clock">12:00:00</div>
    <div class="tab">DEL: 0</div>
    <div class="tab">PROG: 0</div>
    <div class="tab" style="margin-left: auto" id="acct-id-disp">ID: ----</div>
  </header>

  <main id="main">
    <section id="script" class="win-in"></section>
    <section id="disclaimer" class="win-in"></section>
    <section id="form" class="win-in"></section>
    <section id="oncall" class="win-in"></section>
    <section id="info" class="win-in"></section>
  </main>

  <aside id="sidebar" class="win-out"></aside>
  
  <footer id="dbar">
    <input type="text" id="dbar-in" placeholder="ENTER ACCOUNT ID...">
  </footer>
</div>

<div id="overlay"></div>

<script>
/**
 * SPECTRUM FAKE - AXIOMATIC ARCHITECTURE
 * 1. State: Reactive proxy.
 * 2. Schema: Defines behavior.
 * 3. Component: Morphs based on schema.
 */

// --- 1. CORE & STATE ---
const EventBus = new EventTarget();
const State = new Proxy({
  account: null,     // Current Schema
  form: { step: 0, field: 0, values: {} }, 
  popup: null,       // { type, data }
  mode: 'IDLE',      // 'IDLE' | 'INPUT'
  editingId: null    // If editing a message
}, {
  set(target, key, value) {
    target[key] = value;
    EventBus.dispatchEvent(new CustomEvent(`state:${key}`, { detail: value }));
    return true;
  }
});

// --- 2. STORAGE & DATA ---
const DB = {
  accounts: {
    '2000': {
      id: '2000', name: 'Training Account 6-7',
      script: [
        { text: 'TRAINING ACCOUNT - APPOINTMENT SCHEDULING', style: 'normal' },
        { text: '✓ Verify caller identity', style: 'good' },
        { text: '✓ Confirm appointment location', style: 'good' },
        { text: '⚠ DO NOT provide pricing info', style: 'warn' }
      ],
      disclaimer: 'IFS DISCLAIMER: This is a simulation. Do not enter real PII.',
      form: {
        hint: 'Tab to navigate. Shift+Enter to submit.',
        steps: [
          [
            { id: 'loc', type: 'dropdown', label: 'Location', opts: ['New York', 'Chicago', 'LA'], default: 'New York' },
            { id: 'name', type: 'text', label: 'Caller Name', req: true }
          ],
          [
            { id: 'phone', type: 'phone', label: 'Phone', req: true },
            { id: 'type', type: 'dropdown', label: 'Appt Type', opts: ['Install', 'Repair', 'Query'] }
          ],
          [
            { id: 'notes', type: 'textarea', label: 'Notes' }
          ]
        ]
      },
      oncalls: [
        { label: 'Day Mgr', name: 'John Smith', times: '9-5 EST', dial: '555-0101', note: 'Escalations' },
        { label: 'Night Sup', name: 'Jane Doe', times: '5-12 EST', dial: '555-0102', note: 'Emergencies' },
        { label: 'Tech', name: 'Bob Root', times: '24/7', dial: '555-0000' }
      ],
      info: [
        'PAGE 1: GENERAL\n\nWelcome to training.\nUse PageUp/PageDown to navigate info pages.',
        'PAGE 2: POLICIES\n\n1. Be polite.\n2. Be efficient.\n3. Be retro.',
        'PAGE 3: CODES\n\nRed: Urgent\nBlue: Standard\nYellow: Hold'
      ]
    },
    '3000': { id: '3000', name: 'Pizza Palace', script: [{text:'Pizza Order Line'}], form: {steps: [[{id:'t', type:'text', label:'Topping'}]]}, oncalls: [], info: ['Pizza menu...'] },
    '5500': { id: '5500', name: 'Emergency Svcs', script: [{text:'URGENT LINE', style:'warn'}], form: {steps: [[{id:'x', type:'text', label:'Location'}]]}, oncalls: [], info: ['Protocols...'] }
  },
  saveMsg(acctId, data, idToUpdate = null) {
    const key = `msgs_${acctId}`;
    let msgs = JSON.parse(localStorage.getItem(key) || '[]');
    if (idToUpdate) {
      const idx = msgs.findIndex(m => m.id === idToUpdate);
      if (idx > -1) msgs[idx] = { ...msgs[idx], data, updated: new Date() };
    } else {
      msgs.push({ id: crypto.randomUUID(), data, created: new Date() });
    }
    localStorage.setItem(key, JSON.stringify(msgs));
  },
  getMsgs(acctId) { return JSON.parse(localStorage.getItem(`msgs_${acctId}`) || '[]'); }
};

// --- 3. COMPONENTS ---
class Component {
  constructor(id) { this.el = document.getElementById(id); this.schema = null; }
  configure(s) { this.schema = s; this.render(); return this; }
  render() { this.el.innerHTML = ''; }
  handleKey(e) {}
}

class Script extends Component {
  render() {
    this.el.innerHTML = !this.schema ? '<div style="color:#888; padding:10px">SELECT AN ACCOUNT</div>' : 
      this.schema.map(b => `<div class="${b.style === 'good' ? 'sc-good' : b.style === 'warn' ? 'sc-warn' : ''}">${b.text}</div>`).join('');
  }
}

class Info extends Component {
  constructor(id) { super(id); this.page = 0; }
  configure(s) { this.page = 0; return super.configure(s || []); }
  render() {
    if (!this.schema.length) { this.el.innerHTML = ''; return; }
    this.el.innerHTML = `<div id="info-content">${this.schema[this.page]}</div><div id="info-pg">Page ${this.page+1}/${this.schema.length}</div>`;
    this.resize();
  }
  resize() {
    const c = this.el.querySelector('#info-content');
    let s = 14; c.style.fontSize = s + 'px';
    while (c.scrollHeight > this.el.clientHeight - 20 && s > 8) { c.style.fontSize = (--s) + 'px'; }
  }
  handleKey(e) {
    if (e.key === 'PageDown' && this.page < this.schema.length - 1) { this.page++; this.render(); }
    if (e.key === 'PageUp' && this.page > 0) { this.page--; this.render(); }
  }
}

class Oncall extends Component {
  constructor(id) { super(id); this.sel = -1; }
  configure(s) { this.sel = -1; return super.configure(s || []); }
  render() {
    this.el.innerHTML = this.schema.map((o, i) => `
      <div class="oc-row ${i === this.sel ? 'sel' : ''}" data-i="${i}">
        <div class="oc-lbl"><b>${o.label}</b></div><div class="oc-nm" style="text-align:right">${o.name}</div>
        <div class="oc-sub">${o.times}</div>
      </div>`).join('');
    this.el.querySelectorAll('.oc-row').forEach(r => r.onclick = () => {
      this.sel = +r.dataset.i; this.render(); this.open();
    });
  }
  handleKey(e) {
    if (!this.schema.length) return;
    if (e.key === 'ArrowDown') { this.sel = Math.min(this.sel + 1, this.schema.length - 1); this.render(); this.el.children[this.sel]?.scrollIntoView(false); }
    if (e.key === 'ArrowUp') { this.sel = Math.max(this.sel - 1, 0); this.render(); this.el.children[this.sel]?.scrollIntoView(false); }
    if (e.key === 'Enter' && this.sel > -1) this.open();
  }
  open() { State.popup = { type: 'oncall', data: this.schema[this.sel] }; }
}

class Form extends Component {
  configure(s) {
    this.schema = s || { steps: [] }; 
    this.fields = []; // Flattened list of field instances
    this.el.innerHTML = '';
    if (!s) return this;
    
    // Header
    if (s.hint) this.el.innerHTML += `<div class="form-hint">${s.hint}</div>`;
    
    // Steps
    s.steps.forEach((stepFields, stepIdx) => {
      const stepDiv = document.createElement('div');
      stepDiv.className = `step step-${stepIdx}`;
      stepFields.forEach((fSchema) => {
        const wrap = document.createElement('div');
        wrap.className = 'field';
        // Factory for input types
        let inputHtml = '';
        if (fSchema.type === 'dropdown') {
          inputHtml = `<div class="dd-wrap"><div class="dd-disp"><span>${fSchema.default || 'Select...'}</span><span>▼</span></div><div class="dd-list">${fSchema.opts.map(o=>`<div class="dd-opt">${o}</div>`).join('')}</div></div>`;
        } else if (fSchema.type === 'textarea') {
          inputHtml = `<textarea rows="3"></textarea>`;
        } else {
          inputHtml = `<input type="${fSchema.type === 'phone' ? 'tel' : 'text'}" value="${fSchema.default||''}">`;
        }
        wrap.innerHTML = `<label class="label">${fSchema.label}</label>${inputHtml}`;
        wrap.schema = fSchema; // Bind schema to DOM
        stepDiv.appendChild(wrap);
        this.fields.push({ el: wrap, step: stepIdx, type: fSchema.type, val: fSchema.default || '' });
      });
      this.el.appendChild(stepDiv);
    });
    
    this.el.innerHTML += `<div class="submit-bar">ENTER OR TAB TO FILE</div>`;
    this.sync();
    return this;
  }
  
  sync() {
    const { step, field } = State.form;
    const isLast = step === this.schema.steps.length - 1 && field === this.schema.steps[step].length - 1;
    
    // Manage Steps visibility
    this.el.querySelectorAll('.step').forEach((s, i) => s.classList.toggle('active', i <= step));
    this.el.querySelector('.submit-bar').style.display = isLast ? 'block' : 'none';

    // Manage Fields state
    let globalIdx = 0;
    this.schema.steps.forEach((sFields, sIdx) => {
      sFields.forEach((_, fIdx) => {
        const fWrapper = this.fields[globalIdx].el;
        const isActive = sIdx === step && fIdx === field;
        const isPast = sIdx < step || (sIdx === step && fIdx < field);
        
        fWrapper.classList.toggle('active', isActive);
        fWrapper.classList.toggle('locked', isPast);
        
        const inp = fWrapper.querySelector('input, textarea, .dd-disp');
        if (isActive) inp.focus();
        
        // Update values from DOM to memory (reactive binding helper)
        if (fWrapper.querySelector('input, textarea')) {
           this.fields[globalIdx].val = fWrapper.querySelector('input, textarea').value;
        } else {
           fWrapper.querySelector('.dd-disp span').innerText = this.fields[globalIdx].val || 'Select...';
        }
        globalIdx++;
      });
    });
  }

  handleKey(e) {
    if (!this.schema) return;
    const { step, field } = State.form;
    const currentStepFields = this.schema.steps[step];
    
    // Find current field implementation
    let flatIdx = 0;
    for(let i=0; i<step; i++) flatIdx += this.schema.steps[i].length;
    flatIdx += field;
    const fieldObj = this.fields[flatIdx];

    // Dropdown Logic
    if (fieldObj.type === 'dropdown') {
      const list = fieldObj.el.querySelector('.dd-list');
      const isOpen = list.style.display === 'block';
      const opts = fieldObj.el.schema.opts;
      let idx = opts.indexOf(fieldObj.val);

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (!isOpen) { list.style.display = 'block'; }
        else if (idx < opts.length - 1) { fieldObj.val = opts[idx+1]; this.sync(); }
        return;
      }
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (idx > 0) { fieldObj.val = opts[idx-1]; this.sync(); }
        return;
      }
      if (e.key === 'Enter') {
        e.preventDefault();
        if (isOpen) { list.style.display = 'none'; return; }
        // Fallthrough to navigate
      }
    }

    // Navigation
    if (e.key === 'Tab' || (e.key === 'Enter' && !e.shiftKey)) {
      e.preventDefault();
      if (e.shiftKey) { // Back
        if (field > 0) State.form = { ...State.form, field: field - 1 };
        else if (step > 0) State.form = { ...State.form, step: step - 1, field: this.schema.steps[step-1].length - 1 };
      } else { // Fwd
        if (field < currentStepFields.length - 1) State.form = { ...State.form, field: field + 1 };
        else if (step < this.schema.steps.length - 1) State.form = { ...State.form, step: step + 1, field: 0 };
      }
      this.sync();
    }
    
    // Submit
    if (e.key === 'Enter' && e.shiftKey) {
      const isLast = step === this.schema.steps.length - 1 && field === currentStepFields.length - 1;
      if (isLast) {
        const data = {};
        this.fields.forEach(f => data[f.el.schema.id] = f.val);
        DB.saveMsg(State.account.id, data, State.editingId);
        State.editingId = null;
        State.form = { step: 0, field: 0 }; // Reset
        this.configure(this.schema); // Re-render clean
        alert('FILED TO DATABASE');
      }
    }
  }

  fill(data) {
    this.fields.forEach(f => {
      if (data[f.el.schema.id]) f.val = data[f.el.schema.id];
    });
    this.sync();
  }
}

class Popup extends Component {
  constructor(id) { super(id); this.sel = 0; }
  render() {
    this.el.style.display = State.popup ? 'flex' : 'none';
    if (!State.popup) return;
    
    const { type, data } = State.popup;
    let title = '', body = '', acts = '';
    this.list = null; // for navigation

    if (type === 'accounts') {
      title = 'SELECT ACCOUNT';
      this.list = Object.values(DB.accounts);
      body = this.list.map((a, i) => `<div class="pop-item ${i===this.sel?'sel':''}" data-i="${i}">${a.id} - ${a.name}</div>`).join('');
    } else if (type === 'messages') {
      title = 'HISTORY';
      this.list = data;
      body = data.length ? data.map((m, i) => `<div class="pop-item ${i===this.sel?'sel':''}" data-i="${i}">${m.created.slice(0,10)} - ${JSON.stringify(m.data).slice(0,30)}...</div>`).join('') : '<div style="padding:10px">No messages found.</div>';
    } else if (type === 'oncall') {
      title = 'CONTACT DETAIL';
      body = `<div style="padding:10px"><b>${data.name}</b><br>${data.label}<br>${data.times}<br><br><i>${data.note||''}</i></div>`;
      acts = `<button onclick="actions.pmd()">PMD</button><button onclick="actions.dial('${data.dial}')">DIAL</button>`;
    } else if (type === 'dial') {
      title = 'DIALING...';
      body = `<div style="font-size:24px; font-family:monospace; text-align:center; padding:20px; color:lime; background:black">${data}</div>`;
      acts = `<button onclick="State.popup=null">HANG UP</button>`;
    } else if (type === 'msg_detail') {
      title = 'MESSAGE VIEW';
      body = `<div style="padding:10px"><pre>${JSON.stringify(data.data, null, 2)}</pre></div>`;
    }

    this.el.innerHTML = `
      <div class="popup">
        <div class="pop-h"><span>${title}</span><span style="cursor:pointer" onclick="State.popup=null">X</span></div>
        <div class="pop-b">${body}</div>
        ${acts ? `<div class="pop-act">${acts}</div>` : ''}
      </div>`;
    
    // Bind click
    this.el.querySelectorAll('.pop-item').forEach(el => {
      el.onclick = () => this.select(+el.dataset.i);
    });
  }

  select(idx) {
    const { type } = State.popup;
    if (type === 'accounts') {
      actions.loadAccount(this.list[idx].id);
    } else if (type === 'messages') {
      State.popup = { type: 'msg_detail', data: this.list[idx] }; // Drill down
    }
  }

  handleKey(e) {
    if (!State.popup) return;
    if (e.key === 'Escape') { State.popup = null; return; }
    
    // List nav
    if (this.list) {
      if (e.key === 'ArrowDown') { this.sel = Math.min(this.sel+1, this.list.length-1); this.render(); }
      if (e.key === 'ArrowUp') { this.sel = Math.max(this.sel-1, 0); this.render(); }
      if (e.key === 'Enter') this.select(this.sel);
    }
    
    // Message Detail Actions
    if (State.popup.type === 'msg_detail') {
      if (e.key === 'F12') { // Edit
        State.editingId = State.popup.data.id;
        comps.form.fill(State.popup.data.data);
        State.popup = null;
      }
      if (e.key === 'F4' && e.shiftKey) { // Duplicate
        comps.form.fill(State.popup.data.data);
        State.popup = null;
      }
    }
  }
}

// --- 4. APP WIRING ---
const comps = {
  script: new Script('script'),
  form: new Form('form'),
  oncall: new Oncall('oncall'),
  info: new Info('info'),
  popup: new Popup('overlay')
};

const actions = {
  loadAccount(id) {
    const acct = DB.accounts[id];
    if (acct) {
      State.account = acct;
      State.popup = null;
      State.form = { step: 0, field: 0 };
    } else {
      alert('Account not found');
    }
  },
  pmd() { State.popup = null; alert('PMD SENT'); },
  dial(num) { State.popup = { type: 'dial', data: num }; }
};

// Wiring State to Components
EventBus.addEventListener('state:account', (e) => {
  const s = e.detail;
  document.getElementById('acct-name').innerText = s.name;
  document.getElementById('acct-id-disp').innerText = `ID: ${s.id}`;
  document.getElementById('acct-name').style.color = 'red';
  document.getElementById('disclaimer').innerText = s.disclaimer || '';
  document.getElementById('main').classList.remove('dim');
  
  comps.script.configure(s.script);
  comps.form.configure(s.form);
  comps.oncall.configure(s.oncalls);
  comps.info.configure(s.info);
});

EventBus.addEventListener('state:popup', () => comps.popup.render());
EventBus.addEventListener('state:mode', (e) => {
  const dbar = document.getElementById('dbar');
  const dbarIn = document.getElementById('dbar-in');
  if (e.detail === 'INPUT') {
    dbar.classList.add('input-mode');
    document.getElementById('main').classList.add('dim');
    dbarIn.value = '';
    dbarIn.focus();
  } else {
    dbar.classList.remove('input-mode');
    document.getElementById('main').classList.remove('dim');
    if (State.account) document.getElementById('main').classList.remove('dim');
  }
});

// Sidebar Generator
const sb = document.getElementById('sidebar');
const btns = ['Sys', 'Queue', 'Accts', 'Dial', 'Hold', 'Xfer', 'Conf', 'Park', 'Mute', 'Rel', 'Log', 'Spv', 'Help', 'Brws', 'Mail', 'Chat', 'Calc', 'Note', 'Cal', 'Map', 'Weath', 'PAGE'];
btns.forEach((b, i) => {
  const btn = document.createElement('div');
  btn.className = `btn ${['Hold','Conf'].includes(b)?'yel':['Park','Xfer'].includes(b)?'pnk':b==='PAGE'?'blk':''}`;
  btn.innerText = b;
  if (b === 'Accts') btn.onclick = () => State.popup = { type: 'accounts' };
  else if (b === 'PAGE') btn.onclick = () => alert('PAGING...');
  else btn.onclick = () => {}; // Dummy
  sb.appendChild(btn);
});

// Clock
setInterval(() => {
  document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', {hour12:false});
}, 1000);

// Global Input Controller
document.addEventListener('keydown', (e) => {
  // Mode Switching
  if (e.key === '+' || e.key === '=') { 
    e.preventDefault(); State.mode = 'INPUT'; return; 
  }
  if (State.mode === 'INPUT') {
    if (e.key === 'Escape' || e.key === '`') { State.mode = 'IDLE'; return; }
    if (e.key === 'Enter') {
      const val = document.getElementById('dbar-in').value;
      actions.loadAccount(val);
      State.mode = 'IDLE';
    }
    return; // Block other keys in input mode
  }

  // Global Hotkeys
  if (e.key === 'F2') { 
    e.preventDefault(); 
    if(State.account) State.popup = { type: 'messages', data: DB.getMsgs(State.account.id) };
    return;
  }
  if (e.key === 'Escape') { State.popup = null; return; }

  // Component Delegation
  if (State.popup) { comps.popup.handleKey(e); return; }
  if (State.account) {
    // Determine active focus based on click (simple heuristic: click sets focus class?)
    // For this retro app, we assume keyboard priority based on key type
    if (e.key === 'Tab' || (e.key === 'Enter' && e.shiftKey)) { comps.form.handleKey(e); return; }
    if (e.key.startsWith('Page')) { comps.info.handleKey(e); return; }
    
    // Ambiguous keys (Arrows, Enter) - Logic: If form has focus (clicked), form wins. Else Oncall.
    // Defaulting to Form for Arrows if dropdown open, else Oncall.
    // Simplifying for UX: Form gets Tab. Oncall gets Arrows. 
    // BUT Dropdowns need arrows.
    
    // Check if a dropdown is open
    const openDD = document.querySelector('.dd-list[style*="block"]');
    if (openDD) { comps.form.handleKey(e); return; }

    if (['ArrowUp', 'ArrowDown'].includes(e.key)) comps.oncall.handleKey(e);
    if (e.key === 'Enter') comps.oncall.handleKey(e); // Opens popup
  }
});

// Initialize
document.getElementById('main').classList.add('dim'); // Start dimmed
</script>
</body>
</html>
